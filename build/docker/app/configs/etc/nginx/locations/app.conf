# redirect to S3
location ~ (^/images/|^/files/) {
    resolver 10.110.0.1 10.110.1.1;

    proxy_send_timeout 1200s;
    proxy_read_timeout 1200s;

    proxy_set_header Cookie '';
    proxy_set_header Authorization '';
    proxy_set_header x-user-products "";

    set $AWS_S3_USER_SUFFIX $NGINX_ENVIRONMENT;

    if ($NGINX_ENVIRONMENT ~ dev|local) {
        set $AWS_S3_USER_SUFFIX dev;
    }

    if ($http_x_host ~ "ru-ru\.([a-zA-Z0-9]+)_([a-zA-Z0-9\-]+)_([a-zA-Z0-9]+)") {
        set $AWS_S3_BUCKET "$1.$2.$3";
        proxy_pass http://s3.aservices.tech/erprof$AWS_S3_USER_SUFFIX:$AWS_S3_BUCKET$uri;
    }

    proxy_redirect off;
}

# получение приказов по простой ссылке из АПИ
location ~ ^/order/[0-9]+.pdf {
    rewrite ^/.*/(.*).pdf /api/v1/specialist-order-pdf_get-by-id?id=$1 break ;

    proxy_send_timeout 1200s;
    proxy_read_timeout 1200s;
    proxy_pass         http://127.0.0.1;
}

# получение документов по простой ссылке из АПИ
location ~ ^/document/[0-9]+.png {
    rewrite ^/.*/(.*).png /api/v1/specialist-document-image_get-by-id?id=$1 break ;

    proxy_send_timeout 1200s;
    proxy_read_timeout 1200s;
    proxy_pass         http://127.0.0.1;
}
